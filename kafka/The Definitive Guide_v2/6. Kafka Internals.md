##  Cluster Membership

- Kafka uses Apache ZooKeeper to maintain the list of brokers that are currently mem‐ bers of a cluster. 
- Every broker has a unique identifier that is either set in the broker configuration file or automatically generated. E
- Every time a broker process starts, it registers itself with its ID in ZooKeeper by creating an [ephemeral node](https://zookeeper.apache.org/doc/r3.4.8/zookeeperProgrammers.html#Ephemeral+Nodes). ephemaral (수명이 짧은, 단명하는)


When a broker loses connectivity to ZooKeeper (usually as a result of the broker stopping, but this can also happen as a result of network partition or a long garbage- collection pause), the ephemeral node that the broker created when starting will be automatically removed from ZooKeeper. 

Kafka components that are watching the list of brokers will be notified that the broker is gone.


-- 이 부분 이해 덜 되었음 --
Even though the node representing the broker is gone when the broker is stopped, the broker ID still exists in other data structures. For example, the list of replicas of each topic  contains the broker IDs for the replica. This way, if you completely lose a broker and start a brand-new broker with the ID of the old one, it will immediately join the cluster in place of the missing broker with the same partitions and topics assigned to it.

## Controller

- The controller is one of the Kafka brokers that, in addition to the usual broker func‐ tionality, is responsible for electing partition leaders.

When the ephemeral node disappears, other brokers in the cluster will be notified through the ZooKeeper watch that the controller is gone and will attempt to create the controller node in ZooKeeper themselves. The first node to create the new controller in ZooKeeper becomes the next controller, while the other nodes will receive a “node already exists” exception and re-create the watch on the new controller node. Each time a controller is elected, it receives a new, higher controller epoch number through a ZooKeeper conditional increment opera‐ tion. The brokers know the current controller epoch, and if they receive a message from a controller with an older number, they know to ignore it. This is important because the controller broker can disconnect from ZooKeeper due to a long garbage collection pause—during this pause a new controller will be elected. When the previ‐ ous leader resumes operations after the pause, it can continue sending messages to brokers without knowing that there is a new controller—in this case, the old
